<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVMe Drive History Records</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .history-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-history {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-refresh { background: #3498db; color: white; }
        .btn-export { background: #2ecc71; color: white; }
        .btn-clear { background: #e74c3c; color: white; }
        
        .db-stats {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .history-table-container {
            overflow-x: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .history-table th,
        .history-table td {
            padding: 10px 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .history-table th {
            background: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }
        
        .history-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .history-table tr:hover {
            background: #e8f4fd;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading-spinner i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-manual { background: #3498db; color: white; }
        .badge-system { background: #2ecc71; color: white; }
        .badge-unknown { background: #95a5a6; color: white; }
        
        .action-btn {
            padding: 5px 8px;
            margin: 0 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .action-view { background: #3498db; color: white; }
        .action-run { background: #f39c12; color: white; }
        .action-delete { background: #e74c3c; color: white; }
        
        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .nav-links a {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-history"></i> NVMe Drive History Records</h1>
            <p class="subtitle">Complete MySQL Table History - View all records from database with full column details</p>
        </header>
        
        <div class="nav-links">
            <a href="index.html"><i class="fas fa-home"></i> Main Dashboard</a>
            <a href="history.html"><i class="fas fa-history"></i> History Records</a>
        </div>

        <div class="history-container">
            <div class="history-header">
                <div>
                    <h2><i class="fas fa-table"></i> Complete MySQL Table History</h2>
                    <p>View all records from database with full column details</p>
                </div>
                <div class="history-actions">
                    <button id="refreshHistoryBtn" class="btn-history btn-refresh" title="Refresh data">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="exportHistoryBtn" class="btn-history btn-export" title="Export to CSV">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button id="clearHistoryBtn" class="btn-history btn-clear" title="Clear all records">
                        <i class="fas fa-trash-alt"></i> Clear All
                    </button>
                </div>
            </div>
            
            <div class="db-stats">
                <span><i class="fas fa-database"></i> <span id="totalRecords">0</span> total records</span>
            </div>
            
            <div class="history-table-container">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Timestamp</th>
                            <th>Power Hours</th>
                            <th>TBW (TB)</th>
                            <th>TBR (TB)</th>
                            <th>Temp (¬∞C)</th>
                            <th>Life Used %</th>
                            <th>Media Err</th>
                            <th>Unsafe Shut</th>
                            <th>CRC Err</th>
                            <th>Read Err</th>
                            <th>Write Err</th>
                            <th>Thresh (¬∞C)</th>
                            <th>Source</th>
                            <th>Notes</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="17">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading complete history from database...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // Load history on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);
            document.getElementById('exportHistoryBtn').addEventListener('click', exportHistory);
            document.getElementById('clearHistoryBtn').addEventListener('click', showClearAllConfirmation);
        }
        
        async function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            const totalSpan = document.getElementById('totalRecords');
            
            if (!tbody) {
                console.error('‚ùå History table body element not found');
                return;
            }
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="17">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Loading complete history from database...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                console.log('üìä Fetching complete history from:', `${API_BASE_URL}/history`);
                
                const response = await fetch(`${API_BASE_URL}/history`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ History response:', result);
                
                if (result.success) {
                    if (totalSpan) {
                        const totalCount = result.total_count || (result.data ? result.data.length : 0);
                        totalSpan.textContent = totalCount;
                        console.log(`üìä Updated total records to: ${totalCount}`);
                    }
                    
                    if (result.data && Array.isArray(result.data) && result.data.length > 0) {
                        console.log(`üìä Processing ${result.data.length} records`);
                        displayCompleteHistory(result.data);
                    } else {
                        console.log('üìä No data to display');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="17" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-database fa-3x" style="color: #95a5a6; margin-bottom: 15px;"></i>
                                    <h3 style="color: #2c3e50;">No History Entries Found</h3>
                                    <p style="color: #7f8c8d;">Make a prediction to see data here</p>
                                    <a href="index.html" class="btn btn-primary" style="display: inline-block; margin-top: 10px;">
                                        <i class="fas fa-chart-line"></i> Go to Predict
                                    </a>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    throw new Error(result.error || 'Failed to load history');
                }
            } catch (error) {
                console.error('‚ùå Error loading history:', error);
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="17" style="text-align: center; padding: 40px; color: #e74c3c;">
                                <i class="fas fa-exclamation-triangle fa-3x" style="margin-bottom: 15px;"></i>
                                <h3>Error Loading History</h3>
                                <p>${error.message}</p>
                                <button class="btn btn-primary" onclick="loadHistory()" style="margin-top: 10px;">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        function displayCompleteHistory(entries) {
            console.log('üìä Starting displayCompleteHistory with', entries.length, 'entries');
            
            try {
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) {
                    console.error('‚ùå History table body element not found in displayCompleteHistory');
                    return;
                }
                
                console.log('‚úÖ Found tbody element, proceeding with', entries.length, 'entries');
                
                let html = '';
                
                entries.forEach((entry, index) => {
                    try {
                        // Safely parse dates
                        const date = new Date(entry.timestamp);
                        const formattedDate = isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        const createdDateObj = entry.created_at ? new Date(entry.created_at) : null;
                        const createdDate = createdDateObj && !isNaN(createdDateObj.getTime()) ? createdDateObj.toLocaleString() : '-';
                        
                        // Determine badge class based on data source
                        const source = entry.data_source || 'unknown';
                        const badgeClass = `badge badge-${source}`;
                        
                        // Format values with proper units, with safety checks
                        const powerHours = (entry.power_on_hours != null ? Number(entry.power_on_hours) : 0).toLocaleString();
                        const tbw = (entry.total_tbw_tb != null ? Number(entry.total_tbw_tb) : 0).toFixed(2);
                        const tbr = (entry.total_tbr_tb != null ? Number(entry.total_tbr_tb) : 0).toFixed(2);
                        const temp = (entry.temperature_c != null ? Number(entry.temperature_c) : 0).toFixed(1);
                        const lifeUsed = (entry.percent_life_used != null ? Number(entry.percent_life_used) : 0).toFixed(1);
                        const mediaErrors = entry.media_errors != null ? Number(entry.media_errors) : 0;
                        const unsafeShutdowns = entry.unsafe_shutdowns != null ? Number(entry.unsafe_shutdowns) : 0;
                        const crcErrors = entry.crc_errors != null ? Number(entry.crc_errors) : 0;
                        const readError = (entry.read_error_rate != null ? Number(entry.read_error_rate) : 0).toFixed(3);
                        const writeError = (entry.write_error_rate != null ? Number(entry.write_error_rate) : 0).toFixed(3);
                        const threshold = (entry.temp_threshold != null ? Number(entry.temp_threshold) : 84).toFixed(0);
                        const notes = entry.notes ? String(entry.notes).substring(0, 20) + (String(entry.notes).length > 20 ? '...' : '') : '-';
                        
                        html += `
                            <tr>
                                <td><strong>${entry.id}</strong></td>
                                <td>${formattedDate}</td>
                                <td>${powerHours}</td>
                                <td>${tbw}</td>
                                <td>${tbr}</td>
                                <td>${temp}¬∞C</td>
                                <td>${lifeUsed}%</td>
                                <td>${mediaErrors}</td>
                                <td>${unsafeShutdowns}</td>
                                <td>${crcErrors}</td>
                                <td>${readError}</td>
                                <td>${writeError}</td>
                                <td>${threshold}¬∞C</td>
                                <td><span class="${badgeClass}">${source}</span></td>
                                <td>${notes}</td>
                                <td>${createdDate}</td>
                                <td class="action-cell">
                                    <button class="action-btn action-view" onclick="viewHistoryEntry(${entry.id})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn action-run" onclick="runHistoryEntryDirect(${entry.id})" title="Run Analysis">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="action-btn action-delete" onclick="showDeleteConfirmation(${entry.id})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        console.log('Successfully processed entry', entry.id);
                    } catch (entryError) {
                        console.error(`‚ùå Error processing entry ${entry.id || index}:`, entryError);
                        console.log('Entry data:', entry);
                    }
                });
                
                console.log('Generated HTML length:', html.length);
                tbody.innerHTML = html;
                console.log(`‚úÖ Successfully set HTML for ${entries.length} records in history table`);
                
            } catch (error) {
                console.error('‚ùå Critical error in displayCompleteHistory function:', error);
                const tbody = document.getElementById('historyTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="17" style="text-align: center; padding: 40px; color: #e74c3c;">
                                <i class="fas fa-exclamation-triangle fa-3x" style="margin-bottom: 15px;"></i>
                                <h3>Error Displaying History</h3>
                                <p>See console for details</p>
                                <button class="btn btn-primary" onclick="loadHistory()" style="margin-top: 10px;">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        function exportHistory() {
            const table = document.getElementById('historyTable');
            const rows = table.querySelectorAll('tr');
            let csv = [];
            
            // Get headers
            const headers = [];
            table.querySelectorAll('th').forEach(th => {
                if (th.textContent !== 'Actions') {
                    headers.push(th.textContent.trim());
                }
            });
            csv.push(headers.join(','));
            
            // Get data rows
            rows.forEach((row, index) => {
                if (index === 0) return; // Skip header row
                
                const cols = row.querySelectorAll('td');
                if (cols.length > 0) {
                    const data = [];
                    for (let i = 0; i < cols.length - 1; i++) { // Skip actions column
                        let text = cols[i].textContent.trim();
                        // Remove icons but keep data
                        text = text.replace(/[^\d.,¬∞%TB\s-]/g, '').trim();
                        data.push(`"${text}"`);
                    }
                    csv.push(data.join(','));
                }
            });
            
            // Download CSV
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nvme_complete_history_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            alert('History exported to CSV successfully!');
        }
        
        function showClearAllConfirmation() {
            if (confirm('‚ö†Ô∏è Delete ALL history entries? This action cannot be undone.')) {
                clearAllHistory();
            }
        }
        
        async function clearAllHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/history/clear`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadHistory(); // Reload the history after clearing
                } else {
                    alert('Failed to clear history: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error clearing history: ' + error.message);
            }
        }
        
        async function runHistoryEntryDirect(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/history/${id}`);
                if (!response.ok) throw new Error('Failed to load entry');
                
                const result = await response.json();
                
                if (result.success) {
                    // Open the main dashboard with the history data pre-filled
                    window.open('index.html', '_blank');
                    // In a real implementation, we would send the data to the main page
                    alert(`Would run analysis for entry #${id}. Open the main dashboard to use this data.`);
                } else {
                    alert('Failed to load history entry');
                }
            } catch (error) {
                alert('Error loading history entry: ' + error.message);
            }
        }
        
        function viewHistoryEntry(id) {
            // Create a modal or redirect to a detailed view
            alert(`Viewing details for entry #${id}. This would show detailed information in a modal.`);
        }
        
        function showDeleteConfirmation(id) {
            if (confirm(`Delete history entry #${id}? This action cannot be undone.`)) {
                deleteHistoryEntry(id);
            }
        }
        
        async function deleteHistoryEntry(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/history/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Entry #${id} deleted successfully`);
                    loadHistory(); // Reload the history after deletion
                } else {
                    alert('Failed to delete entry: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting entry: ' + error.message);
            }
        }
    </script>
</body>
</html>